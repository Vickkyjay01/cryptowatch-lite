<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CryptoVault — Live Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['"DM Sans"', 'system-ui', 'sans-serif'],
            mono: ['"JetBrains Mono"', 'monospace'],
          },
        },
      },
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'DM Sans', system-ui, sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .card-enter {
      animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      opacity: 0;
    }
    .live-dot {
      animation: pulse-dot 2s ease-in-out infinite;
    }
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 6px;
    }
    .price-flash {
      transition: color 0.3s ease;
    }
    .flash-green { color: #16a34a !important; }
    .flash-red { color: #dc2626 !important; }
    .progress-ring {
      transition: stroke-dashoffset 0.3s ease;
    }
    .card-hover {
      transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.2s ease;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <header class="bg-white border-b border-gray-100 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-gray-900 rounded-lg flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
            </svg>
          </div>
          <h1 class="text-lg font-semibold text-gray-900 tracking-tight">CryptoVault</h1>
          <span class="hidden sm:inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Dashboard</span>
        </div>
        <div class="flex items-center gap-4">
          <div id="countdown-container" class="hidden sm:flex items-center gap-2 text-xs text-gray-400">
            <svg class="w-3.5 h-3.5" viewBox="0 0 36 36">
              <circle cx="18" cy="18" r="15.5" fill="none" stroke="#e5e7eb" stroke-width="3"/>
              <circle id="countdown-ring" cx="18" cy="18" r="15.5" fill="none" stroke="#6366f1" stroke-width="3"
                stroke-dasharray="97.39" stroke-dashoffset="0" stroke-linecap="round"
                transform="rotate(-90 18 18)" class="progress-ring"/>
            </svg>
            <span id="countdown-text">30s</span>
          </div>
          <div id="status-badge" class="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-gray-100 text-gray-400 text-xs font-medium">
            <span id="status-dot" class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
            <span id="status-text">Connecting</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Market Summary Bar -->
    <div id="market-summary" class="mb-8 flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-500">
      <div class="flex items-center gap-1.5">
        <span class="text-gray-400">Total Market Cap</span>
        <span id="total-mcap" class="font-medium text-gray-700 mono">—</span>
      </div>
      <div class="hidden sm:block w-px h-4 bg-gray-200"></div>
      <div class="hidden sm:flex items-center gap-1.5">
        <span class="text-gray-400">24h Volume</span>
        <span id="total-vol" class="font-medium text-gray-700 mono">—</span>
      </div>
      <div class="hidden sm:block w-px h-4 bg-gray-200"></div>
      <div class="hidden sm:flex items-center gap-1.5">
        <span class="text-gray-400">BTC Dominance</span>
        <span id="btc-dom" class="font-medium text-gray-700 mono">—</span>
      </div>
      <div class="ml-auto text-xs text-gray-400">
        Last updated: <span id="last-updated" class="mono">—</span>
      </div>
    </div>

    <!-- Cards Grid -->
    <div id="crypto-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Skeleton loaders -->
      <div class="bg-white rounded-2xl border border-gray-100 p-5 space-y-4">
        <div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-full"></div><div class="space-y-2 flex-1"><div class="skeleton h-4 w-20"></div><div class="skeleton h-3 w-12"></div></div></div>
        <div class="skeleton h-8 w-32"></div><div class="skeleton h-4 w-24"></div>
      </div>
      <div class="bg-white rounded-2xl border border-gray-100 p-5 space-y-4">
        <div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-full"></div><div class="space-y-2 flex-1"><div class="skeleton h-4 w-20"></div><div class="skeleton h-3 w-12"></div></div></div>
        <div class="skeleton h-8 w-32"></div><div class="skeleton h-4 w-24"></div>
      </div>
      <div class="bg-white rounded-2xl border border-gray-100 p-5 space-y-4">
        <div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-full"></div><div class="space-y-2 flex-1"><div class="skeleton h-4 w-20"></div><div class="skeleton h-3 w-12"></div></div></div>
        <div class="skeleton h-8 w-32"></div><div class="skeleton h-4 w-24"></div>
      </div>
      <div class="bg-white rounded-2xl border border-gray-100 p-5 space-y-4">
        <div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-full"></div><div class="space-y-2 flex-1"><div class="skeleton h-4 w-20"></div><div class="skeleton h-3 w-12"></div></div></div>
        <div class="skeleton h-8 w-32"></div><div class="skeleton h-4 w-24"></div>
      </div>
      <div class="bg-white rounded-2xl border border-gray-100 p-5 space-y-4">
        <div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-full"></div><div class="space-y-2 flex-1"><div class="skeleton h-4 w-20"></div><div class="skeleton h-3 w-12"></div></div></div>
        <div class="skeleton h-8 w-32"></div><div class="skeleton h-4 w-24"></div>
      </div>
      <div class="bg-white rounded-2xl border border-gray-100 p-5 space-y-4">
        <div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-full"></div><div class="space-y-2 flex-1"><div class="skeleton h-4 w-20"></div><div class="skeleton h-3 w-12"></div></div></div>
        <div class="skeleton h-8 w-32"></div><div class="skeleton h-4 w-24"></div>
      </div>
      <div class="bg-white rounded-2xl border border-gray-100 p-5 space-y-4">
        <div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-full"></div><div class="space-y-2 flex-1"><div class="skeleton h-4 w-20"></div><div class="skeleton h-3 w-12"></div></div></div>
        <div class="skeleton h-8 w-32"></div><div class="skeleton h-4 w-24"></div>
      </div>
      <div class="bg-white rounded-2xl border border-gray-100 p-5 space-y-4">
        <div class="flex items-center gap-3"><div class="skeleton w-10 h-10 rounded-full"></div><div class="space-y-2 flex-1"><div class="skeleton h-4 w-20"></div><div class="skeleton h-3 w-12"></div></div></div>
        <div class="skeleton h-8 w-32"></div><div class="skeleton h-4 w-24"></div>
      </div>
    </div>

    <!-- Error Banner -->
    <div id="error-banner" class="hidden mt-6 bg-red-50 border border-red-100 rounded-xl p-4 flex items-start gap-3">
      <svg class="w-5 h-5 text-red-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
      </svg>
      <div>
        <p class="text-sm font-medium text-red-800">Unable to fetch live data</p>
        <p id="error-detail" class="text-xs text-red-600 mt-0.5">Using cached data. Will retry automatically.</p>
      </div>
      <button onclick="document.getElementById('error-banner').classList.add('hidden')" class="ml-auto text-red-400 hover:text-red-600">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
  </main>

  <!-- Footer -->
  <footer class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 border-t border-gray-100 mt-8">
    <div class="flex flex-col sm:flex-row items-center justify-between gap-2 text-xs text-gray-400">
      <span>Data provided by CoinGecko API</span>
      <span>Auto-refreshes every 30 seconds</span>
    </div>
  </footer>

  <script>
    // ─── Configuration ────────────────────────────
    const COINS = ['bitcoin', 'ethereum', 'solana', 'dogecoin', 'tether', 'usd-coin', 'usual-usd', 'binancecoin'];

    const COIN_META = {
      bitcoin:     { symbol: 'BTC',  name: 'Bitcoin',     color: '#F7931A', icon: '₿' },
      ethereum:    { symbol: 'ETH',  name: 'Ethereum',    color: '#627EEA', icon: 'Ξ' },
      solana:      { symbol: 'SOL',  name: 'Solana',      color: '#9945FF', icon: 'S' },
      dogecoin:    { symbol: 'DOGE', name: 'Dogecoin',    color: '#C2A633', icon: 'Ð' },
      tether:      { symbol: 'USDT', name: 'Tether',      color: '#26A17B', icon: '₮' },
      'usd-coin':  { symbol: 'USDC', name: 'USD Coin',    color: '#2775CA', icon: '$' },
      'usual-usd': { symbol: 'USD0', name: 'Usual USD',   color: '#1C1C1E', icon: 'U' },
      binancecoin: { symbol: 'BNB',  name: 'BNB',         color: '#F3BA2F', icon: 'B' },
    };

    const REFRESH_INTERVAL = 30;
    const API_URL = 'https://api.coingecko.com/api/v3';

    // ─── State ────────────────────────────────────
    let previousPrices = {};
    let countdown = REFRESH_INTERVAL;
    let countdownTimer = null;
    let fetchInProgress = false;

    // ─── DOM References ───────────────────────────
    const grid = document.getElementById('crypto-grid');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const countdownTextEl = document.getElementById('countdown-text');
    const countdownRing = document.getElementById('countdown-ring');
    const countdownContainer = document.getElementById('countdown-container');
    const errorBanner = document.getElementById('error-banner');
    const errorDetail = document.getElementById('error-detail');
    const lastUpdatedEl = document.getElementById('last-updated');
    const totalMcapEl = document.getElementById('total-mcap');
    const totalVolEl = document.getElementById('total-vol');
    const btcDomEl = document.getElementById('btc-dom');

    // ─── Formatting Helpers ───────────────────────
    function formatPrice(price) {
      if (price == null) return '—';
      if (price >= 1) {
        return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 6 });
    }

    function formatLargeNumber(num) {
      if (num == null) return '—';
      if (num >= 1e12) return '$' + (num / 1e12).toFixed(2) + 'T';
      if (num >= 1e9) return '$' + (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return '$' + (num / 1e6).toFixed(2) + 'M';
      return '$' + num.toLocaleString('en-US');
    }

    function formatPercent(pct) {
      if (pct == null) return '—';
      const sign = pct >= 0 ? '+' : '';
      return sign + pct.toFixed(2) + '%';
    }

    function formatTime(date) {
      return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    // ─── Set Status ───────────────────────────────
    function setStatus(state) {
      if (state === 'live') {
        statusDot.className = 'w-1.5 h-1.5 rounded-full bg-emerald-500 live-dot';
        statusText.textContent = 'Live';
        document.getElementById('status-badge').className = 'flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs font-medium';
      } else if (state === 'fetching') {
        statusDot.className = 'w-1.5 h-1.5 rounded-full bg-indigo-500 live-dot';
        statusText.textContent = 'Updating';
        document.getElementById('status-badge').className = 'flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-indigo-50 text-indigo-700 text-xs font-medium';
      } else if (state === 'error') {
        statusDot.className = 'w-1.5 h-1.5 rounded-full bg-red-400';
        statusText.textContent = 'Offline';
        document.getElementById('status-badge').className = 'flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-red-50 text-red-700 text-xs font-medium';
      } else {
        statusDot.className = 'w-1.5 h-1.5 rounded-full bg-gray-400';
        statusText.textContent = 'Connecting';
        document.getElementById('status-badge').className = 'flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-gray-100 text-gray-400 text-xs font-medium';
      }
    }

    // ─── Build Card HTML ──────────────────────────
    function buildCard(coin, index) {
      const meta = COIN_META[coin.id] || { symbol: '?', name: coin.name, color: '#6B7280', icon: '?' };
      const price = coin.current_price;
      const change24h = coin.price_change_percentage_24h;
      const mcap = coin.market_cap;
      const volume = coin.total_volume;
      const high24 = coin.high_24h;
      const low24 = coin.low_24h;

      const isUp = change24h != null && change24h >= 0;
      const changeColor = isUp ? 'text-emerald-600' : 'text-red-500';
      const changeBg = isUp ? 'bg-emerald-50' : 'bg-red-50';
      const changeIcon = isUp
        ? '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 15l7-7 7 7"/></svg>'
        : '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/></svg>';

      const prevPrice = previousPrices[coin.id];
      let flashClass = '';
      if (prevPrice != null && price != null) {
        if (price > prevPrice) flashClass = 'flash-green';
        else if (price < prevPrice) flashClass = 'flash-red';
      }

      const sparkData = coin.sparkline_in_7d?.price;
      let sparkSvg = '';
      if (sparkData && sparkData.length > 0) {
        const points = sparkData.slice(-24);
        const min = Math.min(...points);
        const max = Math.max(...points);
        const range = max - min || 1;
        const w = 100;
        const h = 32;
        const pathParts = points.map((p, i) => {
          const x = (i / (points.length - 1)) * w;
          const y = h - ((p - min) / range) * h;
          return (i === 0 ? 'M' : 'L') + x.toFixed(1) + ',' + y.toFixed(1);
        });
        const strokeColor = isUp ? '#16a34a' : '#dc2626';
        sparkSvg = `<svg viewBox="0 0 ${w} ${h}" class="w-full h-8 mt-2" preserveAspectRatio="none">
          <path d="${pathParts.join(' ')}" fill="none" stroke="${strokeColor}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>`;
      }

      return `
        <div class="bg-white rounded-2xl border border-gray-100 p-5 card-hover card-enter" style="animation-delay: ${index * 60}ms" data-coin="${coin.id}">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold shadow-sm" style="background-color: ${meta.color}">
                ${meta.icon}
              </div>
              <div>
                <h3 class="text-sm font-semibold text-gray-900">${meta.name}</h3>
                <span class="text-xs text-gray-400 font-medium">${meta.symbol}</span>
              </div>
            </div>
            <div class="flex items-center gap-1 px-2 py-1 rounded-full ${changeBg} ${changeColor} text-xs font-semibold">
              ${changeIcon}
              <span>${formatPercent(change24h)}</span>
            </div>
          </div>

          <div class="price-flash ${flashClass}">
            <p class="text-2xl font-bold text-gray-900 mono tracking-tight">${formatPrice(price)}</p>
          </div>

          ${sparkSvg}

          <div class="mt-4 pt-3 border-t border-gray-50 grid grid-cols-2 gap-3">
            <div>
              <p class="text-xs text-gray-400 mb-0.5">Market Cap</p>
              <p class="text-xs font-medium text-gray-600 mono">${formatLargeNumber(mcap)}</p>
            </div>
            <div>
              <p class="text-xs text-gray-400 mb-0.5">24h Volume</p>
              <p class="text-xs font-medium text-gray-600 mono">${formatLargeNumber(volume)}</p>
            </div>
            <div>
              <p class="text-xs text-gray-400 mb-0.5">24h High</p>
              <p class="text-xs font-medium text-emerald-600 mono">${formatPrice(high24)}</p>
            </div>
            <div>
              <p class="text-xs text-gray-400 mb-0.5">24h Low</p>
              <p class="text-xs font-medium text-red-500 mono">${formatPrice(low24)}</p>
            </div>
          </div>
        </div>
      `;
    }

    // ─── Render All Cards ─────────────────────────
    function renderCards(coins) {
      grid.innerHTML = coins.map((coin, i) => buildCard(coin, i)).join('');

      // Store prices for next flash comparison
      coins.forEach(coin => {
        previousPrices[coin.id] = coin.current_price;
      });

      // Remove flash classes after animation
      setTimeout(() => {
        document.querySelectorAll('.flash-green, .flash-red').forEach(el => {
          el.classList.remove('flash-green', 'flash-red');
        });
      }, 600);
    }

    // ─── Fetch Crypto Data ────────────────────────
    async function fetchPrices() {
      if (fetchInProgress) return;
      fetchInProgress = true;
      setStatus('fetching');

      try {
        const ids = COINS.join(',');
        const url = `${API_URL}/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&per_page=20&page=1&sparkline=true&price_change_percentage=24h`;

        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();

        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('No data returned from API');
        }

        // Sort in the order we defined
        const sorted = COINS.map(id => data.find(c => c.id === id)).filter(Boolean);

        renderCards(sorted);
        lastUpdatedEl.textContent = formatTime(new Date());
        errorBanner.classList.add('hidden');
        setStatus('live');

        // Update global stats
        const btc = data.find(c => c.id === 'bitcoin');
        const totalMcap = data.reduce((sum, c) => sum + (c.market_cap || 0), 0);
        const totalVol = data.reduce((sum, c) => sum + (c.total_volume || 0), 0);
        totalMcapEl.textContent = formatLargeNumber(totalMcap);
        totalVolEl.textContent = formatLargeNumber(totalVol);

        // Rough BTC dominance from our subset
        if (btc && totalMcap > 0) {
          btcDomEl.textContent = ((btc.market_cap / totalMcap) * 100).toFixed(1) + '%';
        }

        // Cache to localStorage
        localStorage.setItem('cryptovault_cache', JSON.stringify({ data: sorted, ts: Date.now() }));

      } catch (err) {
        console.error('Fetch error:', err);
        setStatus('error');

        // Try loading from cache
        const cached = localStorage.getItem('cryptovault_cache');
        if (cached) {
          try {
            const { data: cachedData, ts } = JSON.parse(cached);
            renderCards(cachedData);
            const cacheTime = new Date(ts);
            lastUpdatedEl.textContent = formatTime(cacheTime) + ' (cached)';
            errorDetail.textContent = `Using data from ${formatTime(cacheTime)}. Will retry in ${REFRESH_INTERVAL}s.`;
          } catch (e) {
            errorDetail.textContent = err.message + '. Will retry automatically.';
          }
        } else {
          errorDetail.textContent = err.message + '. Will retry automatically.';
        }

        errorBanner.classList.remove('hidden');
      } finally {
        fetchInProgress = false;
      }
    }

    // ─── Countdown Timer ──────────────────────────
    function startCountdown() {
      countdown = REFRESH_INTERVAL;
      countdownContainer.classList.remove('hidden');

      if (countdownTimer) clearInterval(countdownTimer);

      countdownTimer = setInterval(() => {
        countdown--;
        countdownTextEl.textContent = countdown + 's';

        // Update ring
        const circumference = 97.39;
        const offset = circumference * (1 - countdown / REFRESH_INTERVAL);
        countdownRing.style.strokeDashoffset = offset;

        if (countdown <= 0) {
          countdown = REFRESH_INTERVAL;
          fetchPrices();
        }
      }, 1000);
    }

    // ─── Initialize ───────────────────────────────
    async function init() {
      // Try cache first for instant render
      const cached = localStorage.getItem('cryptovault_cache');
      if (cached) {
        try {
          const { data: cachedData, ts } = JSON.parse(cached);
          const age = Date.now() - ts;
          // Use cache if less than 5 minutes old
          if (age < 5 * 60 * 1000) {
            renderCards(cachedData);
            lastUpdatedEl.textContent = formatTime(new Date(ts)) + ' (cached)';
          }
        } catch (e) { /* ignore bad cache */ }
      }

      await fetchPrices();
      startCountdown();
    }

    // ─── Visibility API — pause/resume when tab hidden ──
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (countdownTimer) clearInterval(countdownTimer);
      } else {
        fetchPrices();
        startCountdown();
      }
    });

    // ─── Start ────────────────────────────────────
    init();
  </script>
</body>
</html>